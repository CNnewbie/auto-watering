<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="utf-8">
    <title>Auto-Watering</title>
    <style>
        #button_style {
            border: 1px solid red;
        }
    </style>

    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-touch-fullscreen" content="YES">
    <meta name="apple-mobile-web-app-capable" content="yes">
</head>

<body>
    <datalist id="timeInputs">
        <option value="now"></option>
        <option value="00:00"></option>
        <option value="09:00"></option>
        <option value="12:00"></option>
        <option value="15:00"></option>
        <option value="18:00"></option>
        <option value="21:00"></option>
    </datalist>
    <datalist id="repeatInputs">
        <option value="1 hour"></option>
        <option value="2 hour"></option>
        <option value="3 hour"></option>
        <option value="6 hour"></option>
        <option value="12 hour"></option>
        <option value="1 day"></option>
        <option value="2 day"></option>
        <option value="3 day"></option>
        <option value="4 day"></option>
        <option value="5 day"></option>
        <option value="6 day"></option>
        <option value="7 day"></option>
    </datalist>
    <datalist id="waters">
        <option value="5"></option>
        <option value="10"></option>
        <option value="20"></option>
        <option value="30"></option>
        <option value="60"></option>
    </datalist>

    <div>
        <div style="margin: 1em;">
            <div id="allInfoText" rows="8" cols="30">xxx</div>
            <button style="margin-top: 1em;" id='refreshBtn' width="100" height="60" style="margin-right: 1em;">刷新</button>
        </div>
        
        <div style="margin: 1em;">
            <div style="margin-top: 1em;">
                开始时间
                <input style="margin-left: 1em;" id="timeInput" list="timeInputs" />
            </div>
            <div style="margin-top: 1em;">
                浇水间隔
                <input style="margin-left: 1em;" id="repeatInput" list="repeatInputs" />
            </div>

            <div style="margin-top: 1em;">
                浇水时长（s）
                <input style="margin-left: 1em;" id="waterInput" list="waters" />
            </div>

            <button style="margin-top: 1em;" id='confirmBtn' width="100" height="60" style="margin-right: 1em;">提交</button>
        </div>
        
        <div style="margin: 1em;">
            <button id='openPumpBtn' width="100" height="60" style="margin-right: 1em;">开水泵</button>
            <button id='closePumpBtn' width="100" height="60">关水泵</button>
        </div>

        <div style="margin: 1em;">
            <button id='openLightBtn' width="100" height="60" style="margin-right: 1em;">开灯</button>
            <button id='closeLightBtn' width="100" height="60">关灯</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function (event) {
            var baseHost = document.location.origin;

            function fetchUrl(url, cb) {
                fetch(url, {
                    method: 'GET',
                    mode: 'cors'
                })
                    .then(function (response) {
                        if (response.status !== 200) {
                            cb(response.status, response.statusText);
                        } else {
                            response.text().then(function (data) {
                                cb(200, data);
                            }).catch(function (err) {
                                cb(-1, err);
                            });
                        }
                    })
                    .catch(function (err) {
                        cb(-1, err);
                    });
            };

            const allInfoText = document.getElementById("allInfoText");
            allInfoText.innerHTML = '';
            function getAll() {
                fetchUrl(`${baseHost}/getAll`, function (code, txt) {
                    json = JSON.parse(txt);
                    text = '开始时间：' + json.start_time + '点</br>';
                    text += '浇水间隔：' + json.repeat_time + '小时</br>';
                    text += '浇水时长：' + json.watering + '秒</br>';
                    text += '空气温度：' + json.temperature + '摄氏度</br>';
                    text += '空气湿度：' + json.humidity + '%</br>';
                    text += '土壤含水量：' + (1024 - json.soil)/1024 + '%</br>';
                    allInfoText.innerHTML = text;
                    console.log(txt);
                });
            };
            
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.onclick = () => {
                getAll();
            };

            const openLightBtn = document.getElementById('openLightBtn');
            openLightBtn.onclick = () => {
                fetchUrl(`${baseHost}/openLight`, function (code, txt) {
                    console.log(code + txt);
                });
            };

            const closeLightBtn = document.getElementById('closeLightBtn');
            closeLightBtn.onclick = () => {
                fetchUrl(`${baseHost}/closeLight`, function (code, txt) {
                    console.log(code + txt);
                });
            };

            const openPumpBtn = document.getElementById('openPumpBtn');
            openPumpBtn.onclick = () => {
                fetchUrl(`${baseHost}/openPump`, function (code, txt) {
                    console.log(code + txt);
                });
            };

            const closePumpBtn = document.getElementById('closePumpBtn');
            closePumpBtn.onclick = () => {
                fetchUrl(`${baseHost}/closePump`, function (code, txt) {
                    console.log(code + txt);
                });
            };

            const timeInput = document.getElementById('timeInput');
            const repeatInput = document.getElementById('repeatInput');
            const confirmBtn = document.getElementById('confirmBtn');
            const waterInput = document.getElementById('waterInput');
            confirmBtn.onclick = () => {
                fetchUrl(`${baseHost}/confirm?time=${timeInput.value}&repeat=${repeatInput.value}&water=${waterInput.value}`, function (code, txt) {
                    console.log(code + txt);
                });
            };
        });
    </script>
</body>

</html>